<div class="card">
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <p-card>
      <ng-template pTemplate="title">
        <i class="pi pi-shopping-cart mr-2"></i>
        {{ isEditMode ? 'Editar Compra' : 'Registrar Nova Compra' }}
      </ng-template>

      <div class="p-fluid grid">
        <div class="field col-12 md:col-6">
          <label for="fornecedorId">Fornecedor</label>
          <p-dropdown
            id="fornecedorId"
            formControlName="fornecedorId"
            [options]="fornecedores"
            optionLabel="nome"
            optionValue="id"
            placeholder="Selecione um fornecedor"
            [filter]="true"
            filterBy="nome"
            [showClear]="true"
          ></p-dropdown>
        </div>

        <div class="field col-12 md:col-6">
          <label for="funcionarioId">Funcionário</label>
          <p-dropdown
            id="funcionarioId"
            formControlName="funcionarioId"
            [options]="funcionarios"
            optionLabel="nome"
            optionValue="id"
            placeholder="Selecione um funcionário"
            [filter]="true"
            filterBy="nome"
            [showClear]="true"
          ></p-dropdown>
        </div>

        <div class="field col-12 md:col-4">
          <label for="dataCompra">Data da Compra</label>
          <p-calendar
            id="dataCompra"
            formControlName="dataCompra"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
          ></p-calendar>
        </div>

        <div class="field col-12 md:col-8">
          <label for="formaPagamento">Forma de Pagamento</label>
          <p-dropdown
            id="formaPagamento"
            formControlName="formaPagamento"
            [options]="formasPagamento"
            placeholder="Selecione a forma de pagamento"
            optionLabel="label"
            optionValue="value"
          ></p-dropdown>
        </div>
      </div>
    </p-card>

    <p-card header="Adicionar Itens à Compra" class="mt-3">
      <div class="p-fluid grid align-items-end">
        <div class="field col-12 md:col-5">
          <label for="produto">Produto</label>
          <p-autoComplete
            id="produto"
            formControlName="produto"
            [suggestions]="produtoSuggestions"
            (completeMethod)="searchProdutos($event)"
            (onSelect)="onProdutoSelect($event)"
            field="nome"
            placeholder="Digite para buscar"
            [forceSelection]="true"
          ></p-autoComplete>
        </div>

        <div class="field col-6 md:col-2">
          <label for="quantidade">Quantidade</label>
          <p-inputNumber
            id="quantidade"
            formControlName="quantidade"
            mode="decimal"
            [min]="1"
          ></p-inputNumber>
        </div>

        <div class="field col-6 md:col-3">
          <label for="precoCusto">Preço de Custo</label>
          <p-inputNumber
            id="precoCusto"
            formControlName="precoCusto"
            mode="currency"
            currency="BRL"
            locale="pt-BR"
          ></p-inputNumber>
        </div>

        <div class="field col-12 md:col-2">
          <button
            pButton
            type="button"
            label="Adicionar"
            icon="pi pi-plus"
            class="p-button-success w-full"
            (click)="addItem()"
            [disabled]="!form.get('produto')?.value || !form.get('quantidade')?.value || form.get('quantidade')?.value <= 0"
          ></button>
        </div>
      </div>
    </p-card>

    <p-card header="Itens da Compra" class="mt-3" *ngIf="items.length > 0">
      <p-table [value]="items" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>Produto</th>
            <th class="text-center" width="150px">Quantidade</th>
            <th class="text-right" width="180px">Preço Custo</th>
            <th class="text-right" width="180px">Subtotal</th>
            <th class="text-center" width="120px">Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-i="rowIndex">
          <tr>
            <td>{{ item.produto?.nome }}</td>
            <td class="text-center">{{ item.quantidade }}</td>
            <td class="text-right">{{ item.precoCusto | currency:'BRL' }}</td>
            <td class="text-right">{{ (item.quantidade * item.precoCusto) | currency:'BRL' }}</td>
            <td class="text-center">
              <button pButton pRipple type="button" icon="pi pi-pencil" class="p-button-rounded p-button-warning mr-2" (click)="editItem(item, i)"></button>
              <button pButton pRipple type="button" icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="removeItem(i)"></button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="3" class="text-right font-bold">Total</td>
            <td class="text-right font-bold">{{ valorTotalCompra | currency:'BRL' }}</td>
            <td></td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
    <div class="col-12">
      <app-installment-config
        [valorTotal]="valorTotalCompra"
        (configChange)="onInstallmentConfigChange($event)"
        (enabledChange)="onInstallmentEnabledChange($event)"
      ></app-installment-config>
    </div>
    <p-card header="Detalhes Finais" class="mt-3">
      <div class="p-fluid grid">
        <div class="field col-12">
          <label for="observacoes">Observações</label>
          <textarea id="observacoes" pInputTextarea formControlName="observacoes" rows="3"></textarea>
        </div>
      </div>
    </p-card>

    <div class="flex justify-content-end mt-4">
      <button
        pButton
        type="submit"
        [label]="isEditMode ? 'Atualizar Compra' : 'Concluir Compra'"
        icon="pi pi-check"
        class="p-button-primary"
        [disabled]="form.invalid || items.length === 0"
      ></button>
    </div>
  </form>
</div>
